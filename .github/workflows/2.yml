name: "ğŸ”„ ManutenÃ§Ã£o Unificada (Playlists + Limpeza + Deploy)"

on:
  schedule:
    - cron: '0 3 * * *'  # Diariamente Ã s 00:00 BRT - Playlists
    - cron: '0 15 * * *'  # 12:00 BRT - Limpeza de arquivos
    - cron: '1 */8 * * *' # A cada 8 horas - Limpeza de execuÃ§Ãµes
    - cron: '25 10 * * *' # 07:25 BRT - Deploy
  workflow_dispatch:
    inputs:
      force_operation:
        description: 'ForÃ§ar operaÃ§Ã£o especÃ­fica'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - playlists
          - cleanup_files
          - cleanup_runs
          - deploy

env:
  TZ: America/Fortaleza
  PYTHONUNBUFFERED: 1

permissions:
  contents: write
  actions: write
  pages: write
  id-token: write

jobs:
  # âœ… 1. JOB: Processamento de Playlists (CORRIGIDO)
  process-playlists:
    name: "ğŸ“¥ Processar Playlists"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    if: >-
      (github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'playlists') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 3 * * *')
    
    steps:
      - name: "ğŸ”½ Checkout PadrÃ£o"
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: "ğŸ Configurar Python com Cache"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: "âš™ï¸ Instalar DependÃªncias RÃ¡pido"
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: "â–¶ï¸ Executar Scripts de Playlist"
        run: |
          # FunÃ§Ã£o para executar script com tratamento de erro
          run_playlist_script() {
            local script=$1
            if [[ -f "$script" ]]; then
              echo "ğŸ”„ Executando: $script"
              if python "$script"; then
                echo "âœ… $script concluÃ­do com sucesso"
                return 0
              else
                echo "âš ï¸ $script encontrou erros"
                return 1
              fi
            else
              echo "â„¹ï¸ $script nÃ£o encontrado, pulando"
              return 0
            fi
          }
          
          # Executar scripts sequencialmente para evitar conflitos
          run_playlist_script "playlists.py"
          # run_playlist_script "playlists2.py"
          # run_playlist_script "Playlist.py"

      - name: "â±ï¸ Adicionar Timestamp"
        run: |
          timestamp=$(TZ='America/Fortaleza' date '+%d/%m/%Y - %H:%M:%S')
          echo "ğŸ• Adicionando timestamp: $timestamp"
          
          # Adicionar timestamp aos arquivos de playlist
          for file in *.m3u *.xml.gz; do
            if [[ -f "$file" ]]; then
              echo -e "\n\n# Atualizado em $timestamp BRT" >> "$file"
              echo "ğŸ“ Timestamp adicionado: $file"
            fi
          done

      - name: "ğŸ’¾ Commit das AlteraÃ§Ãµes"
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false
          
          # Verificar mudanÃ§as
          if git status --porcelain | grep -q .; then
            echo "ğŸ“¦ Arquivos modificados detectados"
            git add -A
            git commit -m "ğŸ”„ AtualizaÃ§Ã£o automÃ¡tica das playlists $(TZ='America/Fortaleza' date '+%d/%m %H:%M')"
            
            # Sincronizar com remote
            git pull origin main --no-edit || true
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" main
            echo "âœ… AlteraÃ§Ãµes commitadas e enviadas"
          else
            echo "âœ… Nenhuma alteraÃ§Ã£o detectada"
          fi

  # âœ… 2. JOB: Limpeza de Arquivos (CORRIGIDO)
  cleanup-files:
    name: "ğŸ—‘ï¸ Limpar Arquivos TemporÃ¡rios"
    runs-on: ubuntu-latest
    needs: process-playlists
    timeout-minutes: 10
    
    if: >-
      (github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'cleanup_files') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 15 * * *')
    
    steps:
      - name: "ğŸ”½ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ—‘ï¸ Limpeza de Arquivos TemporÃ¡rios"
        run: |
          echo "ğŸ” Iniciando limpeza de arquivos temporÃ¡rios..."
          
          # Lista de arquivos essenciais para NÃƒO deletar
          essential_files=(
            "README.md" ".gitignore" "index.html" "script.js" "style.css"
            "deploy.py" "playlists.py" "playlists2.py" "Playlist.py"
            "downloads_files.py" "generate_metadata.js" "files_metadata.json"
            ".github" "CNAME" "_config.yml"
          )
          
          # PadrÃµes de arquivos para deletar
          patterns_to_remove=(
            "coroa_vidaloka-*.mp4"
            "majormarra-*.mp4"
            "marinahelenabr-*.jpg"
            "*-*-*.jpg" "*-*-*.mp4" "*-*-*.png"
            "temp_*" "*.tmp" "*.temp" "*.log"
          )
          
          deleted_count=0
          total_size=0
          
          # FunÃ§Ã£o para verificar se Ã© arquivo essencial
          is_essential() {
            local file="$1"
            for essential in "${essential_files[@]}"; do
              if [[ "$file" == "$essential" ]] || [[ "$file" == .github/* ]]; then
                return 0
              fi
            done
            return 1
          }
          
          # Processar cada padrÃ£o
          for pattern in "${patterns_to_remove[@]}"; do
            for file in $pattern; do
              if [[ -f "$file" ]] && ! is_essential "$file"; then
                file_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0")
                if rm -f "$file"; then
                  echo "ğŸ—‘ï¸ Deletado: $file ($((file_size/1024)) KB)"
                  ((deleted_count++))
                  ((total_size += file_size))
                fi
              fi
            done
          done
          
          echo "ğŸ“Š Resumo da limpeza:"
          echo "   ğŸ“ Arquivos deletados: $deleted_count"
          echo "   ğŸ’¾ EspaÃ§o liberado: $((total_size/1024)) KB"

      - name: "ğŸ’¾ Commit da Limpeza"
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff-index --quiet HEAD --; then
            echo "âœ… Nenhum arquivo para limpar"
          else
            git add -A
            git commit -m "ğŸ§¹ Limpeza de arquivos temporÃ¡rios - $(TZ='America/Fortaleza' date '+%d/%m %H:%M')"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" main
            echo "âœ… Limpeza commitada com sucesso"
          fi

  # âœ… 3. JOB: Limpeza de ExecuÃ§Ãµes (CORRIGIDO)
  cleanup-runs:
    name: "ğŸ§¹ Limpar ExecuÃ§Ãµes Antigas"
    runs-on: ubuntu-latest
    needs: cleanup-files
    timeout-minutes: 5
    
    if: >-
      (github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'cleanup_runs') ||
      (github.event_name == 'schedule' && github.event.schedule == '1 */8 * * *')
    
    steps:
      - name: "ğŸ—‘ï¸ Limpar ExecuÃ§Ãµes Antigas do Workflow"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Iniciando limpeza de execuÃ§Ãµes antigas..."
          
          WORKFLOW_NAME="ğŸ”„ ManutenÃ§Ã£o Unificada (Playlists + Limpeza + Deploy)"
          KEEP_RUNS=3  # Manter as Ãºltimas 3 execuÃ§Ãµes
          
          # Obter workflow ID
          echo "ğŸ“‹ Buscando ID do workflow..."
          WORKFLOW_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows" \
            | jq -r --arg name "$WORKFLOW_NAME" '.workflows[] | select(.name == $name) | .id')
          
          if [[ -z "$WORKFLOW_ID" || "$WORKFLOW_ID" == "null" ]]; then
            echo "âŒ NÃ£o foi possÃ­vel encontrar o workflow: $WORKFLOW_NAME"
            exit 1
          fi
          
          echo "ğŸ¯ Workflow ID: $WORKFLOW_ID"
          
          # Obter execuÃ§Ãµes para deletar (todas exceto as Ãºltimas KEEP_RUNS)
          RUNS_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?per_page=50&status=completed")
          
          OLD_RUN_IDS=$(echo "$RUNS_JSON" | jq -r ".workflow_runs[$KEEP_RUNS:] | .[] | select(.status == \"completed\") | .id")
          
          if [[ -z "$OLD_RUN_IDS" ]]; then
            echo "âœ… Nenhuma execuÃ§Ã£o antiga para limpar"
            exit 0
          fi
          
          echo "ğŸ—‘ï¸ Encontradas $(echo "$OLD_RUN_IDS" | wc -w) execuÃ§Ãµes para limpar"
          
          # Deletar execuÃ§Ãµes
          counter=0
          for run_id in $OLD_RUN_IDS; do
            echo "ğŸ§¹ Deletando execuÃ§Ã£o: $run_id"
            response_code=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id")
            
            if [[ "$response_code" == "204" ]]; then
              echo "âœ… Deletado: $run_id"
              ((counter++))
            else
              echo "âš ï¸ Erro ao deletar $run_id (HTTP $response_code)"
            fi
            
            sleep 0.5  # Evitar rate limiting
          done
          
          echo "ğŸ‰ Limpeza concluÃ­da: $counter execuÃ§Ãµes removidas"

  # âœ… 4. JOB: Deploy para GitHub Pages (CORRIGIDO)
  deploy-pages:
    name: "ğŸš€ Deploy GitHub Pages"
    runs-on: ubuntu-latest
    needs: cleanup-runs
    timeout-minutes: 8
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    if: >-
      (github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'deploy') ||
      (github.event_name == 'schedule' && github.event.schedule == '25 10 * * *')
    
    steps:
      - name: "ğŸ”½ Checkout do CÃ³digo"
        uses: actions/checkout@v4

      - name: "ğŸ—ï¸ Configurar GitHub Pages"
        uses: actions/configure-pages@v4

      - name: "ğŸ“¦ Upload de Artefatos"
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          exclude-assets: |
            *.py
            *.sh
            .github/workflows/*
            scripts/
            *.tmp
            *.log

      - name: "ğŸš€ Fazer Deploy"
        id: deployment
        uses: actions/deploy-pages@v4

      - name: "ğŸ“¢ Status do Deploy"
        run: |
          if [[ "${{ steps.deployment.outcome }}" == "success" ]]; then
            echo "ğŸ‰ Deploy realizado com sucesso!"
            echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
          else
            echo "âŒ Deploy falhou - verifique os logs acima"
            exit 1
          fi

  # âœ… 5. JOB: RelatÃ³rio Final
  report:
    name: "ğŸ“Š RelatÃ³rio de ExecuÃ§Ã£o"
    runs-on: ubuntu-latest
    needs: [process-playlists, cleanup-files, cleanup-runs, deploy-pages]
    if: always()
    
    steps:
      - name: "ğŸ“ˆ Gerar RelatÃ³rio Consolidado"
        run: |
          echo "================================================"
          echo "ğŸ“Š RELATÃ“RIO DA MANUTENÃ‡ÃƒO UNIFICADA"
          echo "================================================"
          echo "ğŸ• ConcluÃ­do em: $(TZ='America/Fortaleza' date '+%d/%m/%Y %H:%M:%S BRT')"
          echo "ğŸ”§ Workflow: ${{ github.workflow }}"
          echo "ğŸ¯ Acionado por: ${{ github.event_name }}"
          echo ""
          echo "ğŸ“‹ STATUS DAS ETAPAS:"
          echo "---------------------"
          echo "ğŸ“¥ Processar Playlists: ${{ needs.process-playlists.result }}"
          echo "ğŸ—‘ï¸ Limpeza de Arquivos: ${{ needs.cleanup-files.result }}"
          echo "ğŸ§¹ Limpeza de ExecuÃ§Ãµes: ${{ needs.cleanup-runs.result }}"
          echo "ğŸš€ Deploy GitHub Pages: ${{ needs.deploy-pages.result }}"
          echo ""
          
          # Verificar se todos foram bem-sucedidos
          if [[ "${{ needs.process-playlists.result }}" == "success" ]] && \
             [[ "${{ needs.cleanup-files.result }}" == "success" ]] && \
             [[ "${{ needs.cleanup-runs.result }}" == "success" ]] && \
             [[ "${{ needs.deploy-pages.result }}" == "success" ]]; then
            echo "âœ… STATUS GERAL: SUCESSO COMPLETO"
            echo "ğŸ¯ Todos os sistemas operando normalmente"
          else
            echo "âš ï¸ STATUS GERAL: ATENÃ‡ÃƒO REQUERIDA"
            echo "ğŸ“ Algumas etapas podem precisar de verificaÃ§Ã£o"
          fi
          echo "================================================"
