name: "ğŸ”„ ManutenÃ§Ã£o Unificada (Playlists + Limpeza + Deploy)"

on:
  schedule:
    - cron: '0 3 * * *'  # Diariamente Ã s 00:00 BRT - Playlists
    - cron: '0 15 * * *'  # 12:00 BRT - Limpeza de arquivos
    - cron: '1 */8 * * *' # A cada 8 horas - Limpeza de execuÃ§Ãµes
    - cron: '25 10 * * *' # 07:25 BRT - Deploy
  workflow_dispatch:
    inputs:
      force_operation:
        description: 'ForÃ§ar operaÃ§Ã£o especÃ­fica'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - playlists
          - cleanup_files
          - cleanup_runs
          - deploy

env:
  TZ: America/Fortaleza

permissions:
  contents: write
  actions: write
  pages: write
  id-token: write

jobs:
  # âœ… 1. JOB: Processamento de Playlists
  process-playlists:
    name: "ğŸ“¥ Processar Playlists"
    runs-on: ubuntu-latest
    
    if: >-
      github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'playlists' ||
      (github.event_name == 'schedule' && github.event.schedule == '0 3 * * *')
    
    steps:
      - name: "ğŸ”½ Checkout do repositÃ³rio"
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: "ğŸ Configurar Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: "ğŸ“¦ Cache de dependÃªncias"
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: "âš™ï¸ Instalar dependÃªncias"
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: "â–¶ï¸ Executar scripts de playlists"
        run: |
          python playlists.py
          # python playlists2.py  # Descomente se necessÃ¡rio
          # python Playlist.py    # Descomente se necessÃ¡rio

      - name: "â±ï¸ Adicionar timestamp"
        run: |
          for file in $(find . -maxdepth 1 -type f \( -name "*.m3u" -o -name "*.xml.gz" \)); do
            echo -e "\n\n# Atualizado em $(TZ='America/Fortaleza' date '+%d/%m/%Y - %H:%M:%S') BRT" >> "$file"
          done

      - name: "ğŸ’¾ Salvar alteraÃ§Ãµes"
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n "$(git status --porcelain .)" ]]; then
            git add .
            git commit -m "ğŸ”„ AtualizaÃ§Ã£o automÃ¡tica das playlists"
            git pull origin main --no-rebase || true
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main
          else
            echo "âœ… Nenhuma alteraÃ§Ã£o detectada."
          fi

  # âœ… 2. JOB: Limpeza de Arquivos
  cleanup-files:
    name: "ğŸ—‘ï¸ Limpar Arquivos TemporÃ¡rios"
    runs-on: ubuntu-latest
    needs: process-playlists
    
    if: >-
      github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'cleanup_files' ||
      (github.event_name == 'schedule' && github.event.schedule == '0 15 * * *')
    
    steps:
      - name: "ğŸ§¾ Checkout do repositÃ³rio"
        uses: actions/checkout@v4

      - name: "ğŸ—‘ï¸ Executar limpeza de arquivos"
        run: |
          # Arquivos para manter (nÃ£o deletar)
          keep_files=(
            "README.md" "deploy.py" "playlists.py" "playlists2.py" "Playlist.py"
            "downloads_files.py" "generate_metadata.js" "files_metadata.json"
            ".gitignore" ".github" "index.html" "script.js" "style.css"
          )
          
          # Lista de padrÃµes de arquivos para deletar
          patterns_to_delete=(
            "coroa_vidaloka-*.mp4"
            "majormarra-*.mp4" 
            "marinahelenabr-*.jpg"
            "*-*-*.jpg" "*-*-*.mp4" "*-*-*.png"
          )
          
          echo "ğŸ” Procurando arquivos para limpeza..."
          for pattern in "${patterns_to_delete[@]}"; do
            for file in $pattern; do
              if [[ -f "$file" ]]; then
                # Verifica se o arquivo nÃ£o estÃ¡ na lista de manter
                should_delete=true
                for keep in "${keep_files[@]}"; do
                  if [[ "$file" == "$keep" ]]; then
                    should_delete=false
                    break
                  fi
                done
                
                if [[ "$should_delete" == true ]]; then
                  echo "ğŸ—‘ï¸ Deletando: $file"
                  rm -f "$file"
                fi
              fi
            done
          done

      - name: "ğŸ’¾ Commit da limpeza"
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n "$(git status --porcelain .)" ]]; then
            git add .
            git commit -m "ğŸ§¹ Limpeza de arquivos temporÃ¡rios"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main
          else
            echo "âœ… Nenhum arquivo para limpar."
          fi

  # âœ… 3. JOB: Limpeza de ExecuÃ§Ãµes
  cleanup-runs:
    name: "ğŸ§¹ Limpar ExecuÃ§Ãµes Antigas"
    runs-on: ubuntu-latest
    needs: cleanup-files
    
    if: >-
      github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'cleanup_runs' ||
      (github.event_name == 'schedule' && startsWith(github.event.schedule, '1 */8'))
    
    steps:
      - name: "ğŸ—‘ï¸ Limpar execuÃ§Ãµes antigas (>1 hora)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Iniciando limpeza de execuÃ§Ãµes antigas..."
          ./scripts/cleanup_runs.sh

  # âœ… 4. JOB: Deploy para GitHub Pages
  deploy-pages:
    name: "ğŸš€ Deploy GitHub Pages"
    runs-on: ubuntu-latest
    needs: cleanup-runs
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    if: >-
      github.event.inputs.force_operation == 'all' ||
      github.event.inputs.force_operation == 'deploy' ||
      (github.event_name == 'schedule' && github.event.schedule == '25 10 * * *')
    
    steps:
      - name: "ğŸ”½ Checkout do repositÃ³rio"
        uses: actions/checkout@v4

      - name: "ğŸ—ï¸ Configurar Pages"
        uses: actions/configure-pages@v4

      - name: "ğŸ“¦ Upload artifact"
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          exclude-assets: |
            *.py
            *.sh
            .github/workflows/*
            scripts/

      - name: "ğŸš€ Deploy"
        id: deployment
        uses: actions/deploy-pages@v4